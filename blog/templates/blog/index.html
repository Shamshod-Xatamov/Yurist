{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Scrollbarni butunlay yashirish kodi */
    .scrollbar-hide::-webkit-scrollbar {
        display: none; /* Chrome, Safari va Opera uchun */
    }

    .scrollbar-hide {
        -ms-overflow-style: none;  /* IE va Edge uchun */
        scrollbar-width: none;  /* Firefox uchun */
    }
</style>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<section class="py-24 lg:py-32 bg-white min-h-screen">
    <div class="w-full max-w-[1280px] mx-auto px-6 lg:px-12">

        <!-- HEADER -->
        <div class="text-center space-y-4 mb-16">
            <span class="text-yellow-600 tracking-wider uppercase text-sm font-semibold">Huquqiy tahlillar</span>
            <h1 class="text-4xl lg:text-5xl text-gray-900 max-w-3xl mx-auto font-serif font-medium leading-tight">
                Blog & Maqolalar
            </h1>
            <p class="text-xl text-gray-500 max-w-2xl mx-auto leading-relaxed">
                Ekspert yuridik tahlillar, sohadagi yangiliklar va amaliy maslahatlar
            </p>

            <!-- Action Buttons (Admin uchun) -->
            {% if user.is_staff %}
            <div class="pt-4 flex flex-wrap gap-3 justify-center">

                <a href="{% url 'dashboard_home' %}" class="inline-flex items-center h-12 px-6 rounded-md border border-yellow-600 text-yellow-600 font-medium hover:bg-yellow-600 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                    Admin Panel
                </a>
            </div>
            {% endif %}
        </div>

        <!-- SEARCH AND FILTER -->
        <div class="mb-12 space-y-6">
            <!-- Search Input -->
            <div class="relative max-w-2xl mx-auto">
    <i data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"></i>
    <!-- id="search-input" QO'SHILDI -->
    <input
        type="text"
        id="search-input"
        value="{{ search_query }}"
        placeholder="Maqolalarni qidirish…"
        class="w-full pl-12 h-14 rounded-md border border-gray-200 bg-white text-gray-900 focus:outline-none focus:border-yellow-600 focus:ring-1 focus:ring-yellow-600 transition-all placeholder:text-gray-400"
    >
</div>

            <!-- Category Filter (Scrollable) -->
            <!-- Category Filter (Scrollable) -->
<div class="flex items-center gap-3 overflow-x-auto pb-2 scrollbar-hide">
    <i data-lucide="filter" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>

    <!-- "All" Button -->
    <button type="button"
            data-cat=""
            class="filter-btn px-4 py-2 rounded-full whitespace-nowrap transition-all border text-sm font-medium
            {% if not request.GET.cat %} bg-yellow-600 text-white border-yellow-600 {% else %} bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200 {% endif %}">
        Barchasi
    </button>

    <!-- Other Categories -->
    {% for cat in categories %}
    <button type="button"
            data-cat="{{ cat.id }}"
            class="filter-btn px-4 py-2 rounded-full whitespace-nowrap transition-all border text-sm font-medium
            {% if request.GET.cat == cat.id|stringformat:'s' %} bg-yellow-600 text-white border-yellow-600 {% else %} bg-gray-100 text-gray-500 border-transparent hover:bg-gray-200 {% endif %}">
        {{ cat.name }}
    </button>
    {% endfor %}
</div>
        </div>
<div id="blog-dynamic-content" class="min-h-[500px]">
        <!-- FEATURED POST (Faqat qidiruv bo'lmasa va kategoriya tanlanmasa ko'rinadi) -->
        {% if featured_post and posts.number == 1 and  not search_query and not request.GET.cat %}
<div class="mb-16">
    <!-- 1. lg:h-[480px] - Card balandligini kompyuterda fix qildik -->
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:border-yellow-600/50 transition-all duration-300 hover:shadow-2xl group lg:h-[480px]">
        <div class="grid lg:grid-cols-2 gap-0 h-full">

            <!-- Image Wrapper -->
            <!-- 2. h-64 lg:h-full - Mobilda 64, kompyuterda cardning to'liq bo'yini oladi -->
            <div class="relative h-64 lg:h-full w-full overflow-hidden border-r border-gray-100">
                <img src="{{ featured_post.image.url }}"
                     alt="{{ featured_post.title }}"
                     class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                <div class="absolute top-6 left-6">
                    <span class="px-4 py-2 bg-yellow-600 text-white text-xs font-bold uppercase rounded-full shadow-md">
                        Yangi
                    </span>
                </div>
            </div>

            <!-- Content Wrapper -->
            <!-- 3. flex flex-col justify-center h-full - Matnlar cardning o'rtasida chiroyli turadi -->
            <div class="p-8 lg:p-12 flex flex-col justify-center h-full bg-white">
                <div class="space-y-6">
                    <div class="flex items-center gap-3 text-sm text-gray-500">
                        <span class="px-3 py-1 bg-yellow-600/10 text-yellow-700 rounded-full font-medium">
                            {{ featured_post.category.name }}
                        </span>
                        <span class="flex items-center gap-1">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            {{ featured_post.published_date|date:"F d, Y" }}
                        </span>
                    </div>

                    <!-- line-clamp-2: Sarlavha juda uzun bo'lsa cardni buzmaydi -->
                    <h2 class="text-3xl lg:text-4xl text-gray-900 font-serif font-medium leading-tight line-clamp-2">
                        <a href="{% url 'blog_detail' featured_post.uuid %}" class="hover:text-yellow-600 transition-colors">
                            {{ featured_post.title }}
                        </a>
                    </h2>

                    <!-- line-clamp-3: Tavsif 3 qatordan oshsa nuqta-nuqta qiladi -->
                    <p class="text-gray-500 leading-relaxed line-clamp-3 text-lg">
                        {{ featured_post.excerpt }}
                    </p>

                    <div class="flex items-center gap-6 pt-6 border-t border-gray-100">
                        <div class="flex items-center gap-4 text-sm text-gray-400">
                            <div class="flex items-center gap-1" title="O'qish vaqti">
                                <i data-lucide="clock" class="w-4 h-4"></i> <span>{{ featured_post.read_time }} daq</span>
                            </div>
                            <div class="flex items-center gap-1" title="Ko'rishlar">
                                <i data-lucide="eye" class="w-4 h-4"></i> <span>{{ featured_post.views }}</span>
                            </div>
                            <div class="flex items-center gap-1" title="Likelar">
                                <i data-lucide="heart" class="w-4 h-4"></i> <span>{{ featured_post.likes }}</span>
                            </div>
                            <div class="flex items-center gap-1" title="Izohlar">
                                <i data-lucide="message-circle" class="w-4 h-4"></i> <span>{{ featured_post.comments.count }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="pt-2">
                        <a href="{% url 'blog_detail' featured_post.uuid %}" class="inline-flex items-center justify-center h-12 px-8 bg-gray-900 text-white font-medium hover:bg-gray-800 transition rounded-sm w-full sm:w-auto shadow-sm">
                            Maqolani o'qish
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endif %}

        <!-- BLOG GRID -->
        {% if posts %}
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {% for post in posts %}
            <!-- Bu yerda ham rounded-sm o'rniga rounded-2xl yozing -->
<article class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:border-yellow-600/50 transition-all duration-300 hover:shadow-xl group flex flex-col h-full relative">

                <!-- Image Wrapper -->
                <a href="{% url 'blog_detail' post.uuid %}" class="relative aspect-[16/10] overflow-hidden block">
                    <img src="{{ post.image.url }}" alt="{{ post.title }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div>
                    <div class="absolute bottom-4 left-4">
                        <span class="px-3 py-1 bg-yellow-600/90 text-white text-xs font-bold rounded-full shadow-sm">
                            {{ post.category.name }}
                        </span>
                    </div>
                </a>

                <!-- Content -->
                <div class="p-6 space-y-4 flex-1 flex flex-col">
                    <div class="flex items-center gap-3 text-sm text-gray-500">
                        <span class="flex items-center gap-1">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            {{ post.published_date|date:"M d, Y" }}
                        </span>
                        <span>•</span>
                        <span class="flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            {{ post.read_time }} min
                        </span>
                    </div>

                    <h3 class="text-xl text-gray-900 font-serif font-medium line-clamp-2 group-hover:text-yellow-600 transition-colors leading-snug">
                        <a href="{% url 'blog_detail' post.uuid %}">{{ post.title }}</a>
                    </h3>

                    <p class="text-gray-500 text-sm line-clamp-3 leading-relaxed flex-1">
                        {{ post.excerpt }}
                    </p>

                    <!-- Tags -->
                    <div class="flex flex-wrap gap-2">
                        {% for tag in post.tags.all|slice:":3" %}
                        <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium">
                            {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>

                    <!-- Footer Stats -->
                    <div class="flex items-center justify-between pt-4 border-t border-gray-100 mt-auto">
                        <div class="flex items-center gap-4 text-xs text-gray-400">
                            <div class="flex items-center gap-1">
                                <i data-lucide="eye" class="w-3 h-3"></i>
                                <span>{{ post.views }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="heart" class="w-3 h-3"></i>
                                <span>{{ post.likes }}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <i data-lucide="message-circle" class="w-3 h-3"></i>
                                <span>{{ post.comments.count }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                <i data-lucide="search-x" class="w-8 h-8 text-gray-400"></i>
            </div>
            <h3 class="text-xl font-medium text-gray-900 mb-2">Maqolalar topilmadi</h3>
            <p class="text-gray-500">Sizning qidiruvingiz bo'yicha hech qanday natija yo'q.</p>
            <a href="{% url 'blog_list' %}" class="mt-4 inline-block text-yellow-600 hover:underline font-medium">
                Barcha maqolalarga qaytish
            </a>
        </div>
        {% endif %}


        <!-- PAGINATION -->
            {% if posts.has_other_pages %}
            <div class="mt-16 flex justify-center items-center gap-2">
                {% if posts.has_previous %}
                    <button type="button" data-page="{{ posts.previous_page_number }}" class="pagination-btn p-3 rounded-md border border-gray-200 hover:bg-gray-50 transition text-gray-600">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                {% endif %}

                {% for num in posts.paginator.page_range %}
                    {% if posts.number == num %}
                        <span class="w-12 h-12 flex items-center justify-center rounded-md bg-yellow-600 text-white font-bold shadow-md">{{ num }}</span>
                    {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
                        <button type="button" data-page="{{ num }}" class="pagination-btn w-12 h-12 flex items-center justify-center rounded-md border border-gray-200 hover:bg-gray-50 transition text-gray-600">{{ num }}</button>
                    {% endif %}
                {% endfor %}

                {% if posts.has_next %}
                    <button type="button" data-page="{{ posts.next_page_number }}" class="pagination-btn p-3 rounded-md border border-gray-200 hover:bg-gray-50 transition text-gray-600">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                {% endif %}
            </div>
            {% endif %}

        </div> <!-- #blog-dynamic-content tugadi -->




</section>

<script>
   document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('search-input'),
          box = document.getElementById('blog-dynamic-content'),
          btns = document.querySelectorAll('.filter-btn');
    let timer;

    // Asosiy yuklash funksiyasi
    const load = async (page = 1, catId = null) => {
        const q = input.value,
              cat = catId !== null ? catId : new URLSearchParams(location.search).get('cat') || '',
              url = `${location.pathname}?q=${encodeURIComponent(q)}&cat=${cat}&page=${page}`;

        history.pushState({}, '', url);
        box.style.opacity = '0.5';

        try {
            const res = await fetch(url),
                  html = await res.text(),
                  newDoc = new DOMParser().parseFromString(html, 'text/html'),
                  newContent = newDoc.getElementById('blog-dynamic-content');

            if (newContent) {
                box.innerHTML = newContent.innerHTML;
                lucide.createIcons();
                if(page > 1 || q || cat) window.scrollTo({ top: box.offsetTop - 120, behavior: 'smooth' });
            }
        } catch (e) { console.error(e); } finally { box.style.opacity = '1'; }
    };

    // Qidiruv (Debounce)
    input?.addEventListener('input', () => {
        clearTimeout(timer);
        timer = setTimeout(() => load(1), 400);
    });

    // Kategoriya filteri
    btns.forEach(b => b.addEventListener('click', function() {
        btns.forEach(x => x.classList.remove('bg-yellow-600', 'text-white', 'border-yellow-600'));
        this.classList.add('bg-yellow-600', 'text-white', 'border-yellow-600');
        load(1, this.dataset.cat);
    }));

    // Pagination (Delegation)
    document.addEventListener('click', e => {
        const p = e.target.closest('.pagination-btn');
        if (p) load(p.dataset.page);
    });

    lucide.createIcons();
});
</script>
{% endblock %}