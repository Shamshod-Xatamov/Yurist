{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* 1. Base.html dan kelayotgan xabarni vizual stillari bo'yicha topib yashirish */
    .border-l-4.border-green-500, /* Ko'p ishlatiladigan Tailwind classi */
    .messages, .alert {
        display: none !important;
    }

    /* 2. SweetAlert (Delete oynasi) uchun orqa fon xiraligi */
    div:where(.swal2-container).swal2-backdrop-show,
    div:where(.swal2-container).swal2-noanimation {
        backdrop-filter: blur(8px) !important;
        background: rgba(0, 0, 0, 0.4) !important;
    }

    /* 3. Toast (Success xabar) uchun orqa fon tozaligi */
    div:where(.swal2-container).swal2-top-end,
    div:where(.swal2-container).swal2-top-right,
    div:where(.swal2-container).swal2-top {
        backdrop-filter: none !important;
        background: transparent !important;
    }
</style>
<section class="py-24 lg:py-32 bg-background min-h-screen">
    <div class="w-full max-w-[1280px] mx-auto px-6 lg:px-12">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="{% url 'blog_list' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 text-muted-foreground hover:text-foreground pl-0">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                Blogga qaytish
            </a>
        </div>

        <!-- Header -->
        <div class="flex items-center justify-between mb-12">
            <div>
                <h1 class="text-4xl lg:text-5xl text-foreground mb-2" style="font-family: var(--font-heading);">
                    Admin Boshqaruv Paneli
                </h1>
                <p class="text-muted-foreground">Maqolalar va sayt kontentini boshqarish</p>
            </div>


        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <!-- Card 1: Total Posts -->
            <div class="bg-card p-6 rounded-sm border border-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-accent/10 rounded-full flex items-center justify-center">
                        <i data-lucide="file-text" class="w-6 h-6 text-accent"></i>
                    </div>
                    <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                </div>
                <div class="text-3xl text-foreground mb-1" style="font-family: var(--font-heading);">
                    {{ stats.total_posts }}
                </div>
                <div class="text-sm text-muted-foreground">Jami Maqolalar</div>
            </div>

            <!-- Card 2: Total Views (Reactda Likes edi, Backendda Views bor) -->
            <div class="bg-card p-6 rounded-sm border border-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-accent/10 rounded-full flex items-center justify-center">
                        <!-- Iconni "Ko'z" (Views) qildim, chunki ma'lumot views -->
                        <i data-lucide="eye" class="w-6 h-6 text-accent"></i>
                    </div>
                    <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                </div>
                <div class="text-3xl text-foreground mb-1" style="font-family: var(--font-heading);">
                    {{ stats.total_views }}
                </div>
                <div class="text-sm text-muted-foreground">Jami Ko'rishlar</div>
            </div>

            <!-- Card 3: Total Comments -->
            <div class="bg-card p-6 rounded-sm border border-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-accent/10 rounded-full flex items-center justify-center">
                        <i data-lucide="users" class="w-6 h-6 text-accent"></i>
                    </div>
                    <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                </div>
                <div class="text-3xl text-foreground mb-1" style="font-family: var(--font-heading);">
                    {{ stats.total_comments }}
                </div>
                <div class="text-sm text-muted-foreground">Jami Izohlar</div>
            </div>

            <!-- Card 4: Avg Read Time -->
            <div class="bg-card p-6 rounded-sm border border-border">
                <div class="flex items-center justify-between mb-4">
                    <div class="w-12 h-12 bg-accent/10 rounded-full flex items-center justify-center">
                        <!-- Vaqt uchun soat ikonkasini qo'ydim -->
                        <i data-lucide="clock" class="w-6 h-6 text-accent"></i>
                    </div>
                    <i data-lucide="trending-up" class="w-5 h-5 text-green-500"></i>
                </div>
                <div class="text-3xl text-foreground mb-1" style="font-family: var(--font-heading);">
                    {{ stats.avg_read_time }} min
                </div>
                <div class="text-sm text-muted-foreground">O'rtacha o'qish vaqti</div>
            </div>
        </div>

        <!-- Posts Table -->
        <div class="bg-card rounded-sm border border-border overflow-hidden">
            <div class="p-6 border-b border-border flex justify-between items-center">
                <h2 class="text-2xl text-foreground" style="font-family: var(--font-heading);">
                    Barcha Maqolalar
                </h2>
                <!-- React kodida bu tugma yo'q edi, lekin funksionallik uchun qo'shildi -->
                <a href="{% url 'blog_create' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Yangi Qo'shish
                </a>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-muted/50">
                        <tr>
                            <th class="text-left p-4 text-sm text-muted-foreground font-medium">Sarlavha</th>
                            <th class="text-left p-4 text-sm text-muted-foreground font-medium">Kategoriya</th>
                            <th class="text-left p-4 text-sm text-muted-foreground font-medium">Sana</th>
                            <th class="text-center p-4 text-sm text-muted-foreground font-medium">Ko'rishlar</th>
                            <th class="text-center p-4 text-sm text-muted-foreground font-medium">Izohlar</th>
                            <th class="text-right p-4 text-sm text-muted-foreground font-medium">Amallar</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-border">
                        {% for post in posts %}
                        <tr class="hover:bg-muted/30 transition-colors border-b border-border last:border-b-0">
                            <td class="p-4">
                                <div class="max-w-md">
                                    <div class="text-foreground line-clamp-1 font-medium">{{ post.title }}</div>
                                    <div class="text-sm text-muted-foreground line-clamp-1">{{ post.excerpt }}</div>
                                </div>
                            </td>
                            <td class="p-4">
                                <span class="px-3 py-1 bg-accent/10 text-accent rounded-full text-sm whitespace-nowrap">
                                    {{ post.category.name }}
                                </span>
                            </td>
                            <td class="p-4 text-muted-foreground whitespace-nowrap text-sm">
                                {{ post.published_date|date:"d.m.Y" }}
                            </td>
                            <td class="p-4 text-center text-muted-foreground text-sm">
                                {{ post.views }}
                            </td>
                            <td class="p-4 text-center text-muted-foreground text-sm">
                                {{ post.comments.count }}
                            </td>
                            <td class="p-4">
                                <div class="flex items-center justify-end gap-2">
                                    <!-- Edit Button -->
                                    <a href="{% url 'blog_edit' post.uuid %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 hover:bg-muted hover:text-foreground h-9 w-9">
                                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                                    </a>

                                    <!-- Delete Button (Form ichida) -->
                                    <form action="{% url 'blog_delete' post.uuid %}" method="POST" class="delete-form inline-block">
                                        {% csrf_token %}
                                        <!-- type="button" qildik, toki to'g'ridan-to'g'ri submit bo'lmasin -->
                                        <button type="button" onclick="confirmDelete(this)" class="p-2 hover:bg-red-50 text-gray-400 hover:text-red-600 rounded transition-colors">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="p-8 text-center text-muted-foreground">
                                Hozircha maqolalar mavjud emas.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- Lucide Icons Script -->
<script src="https://unpkg.com/lucide@latest"></script>
<script>
  lucide.createIcons();
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- SweetAlert2 kutubxonasi -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Lucide ikonlarini ishga tushirish
    lucide.createIcons();

    function confirmDelete(button) {
        Swal.fire({
            title: 'Ishonchingiz komilmi?',
            text: "Bu maqolani o'chirib yuborsangiz, qayta tiklay olmaysiz!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626', // Qizil rang (Tailwind red-600)
            cancelButtonColor: '#4b5563', // Kulrang
            confirmButtonText: 'Ha, o\'chirilsin!',
            cancelButtonText: 'Bekor qilish',
            // Dizaynni sozlash
            customClass: {
                popup: 'rounded-xl border border-gray-100 shadow-xl',
                confirmButton: 'px-4 py-2 rounded-lg text-sm font-medium',
                cancelButton: 'px-4 py-2 rounded-lg text-sm font-medium'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Agar "Ha" bosilsa, formani yuboramiz
                button.closest('form').submit();
            }
        });
    }

    // Django Messages (Success/Error) uchun ham chiroyli Toast chiqarish
    {% if messages %}
        {% for message in messages %}
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })

            Toast.fire({
                icon: "{{ message.tags }}", // 'success' yoki 'error'
                title: "{{ message }}"
            })
        {% endfor %}
    {% endif %}
</script>
{% endblock %}